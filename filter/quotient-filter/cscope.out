cscope 15 /home/flyhigh2sky/quotient-filter -q 0000000191 0000021138
	@qf.c

7 
	~<°dlib.h
>

8 
	~<°rög.h
>

9 
	~<c°dio
>

11 
	~"qf.h
"

13 
	#MAX
(
a
, 
b
Ë(◊Ë> (bË? (aË: (b))

	)

14 
	#LOW_MASK
(
n
Ë((1ULL << (n)Ë- 1ULL)

	)

16 
boﬁ
 
	$qf_öô
(
quŸõ¡_fûãr
 *
qf
, 
uöt32_t
 
q
, uöt32_à
r
)

18 i‡(
q
 =0 || 
r
 == 0 || q +Ñ > 64) {

19  
Ál£
;

22 
qf
->
qf_qbôs
 = 
q
;

23 
qf
->
qf_rbôs
 = 
r
;

24 
qf
->
qf_ñem_bôs
 = qf->
qf_rbôs
 + 3;

25 
qf
->
qf_ödex_mask
 = 
	`LOW_MASK
(
q
);

26 
qf
->
qf_rmask
 = 
	`LOW_MASK
(
r
);

27 
qf
->
qf_ñem_mask
 = 
	`LOW_MASK
(qf->
qf_ñem_bôs
);

28 
qf
->
qf_íåõs
 = 0;

29 
qf
->
qf_max_size
 = 1 << 
q
;

30 
qf
->
qf_èbÀ
 = (
uöt64_t
 *Ë
	`ˇŒoc
(
	`qf_èbÀ_size
(
q
, 
r
), 1);

31  
qf
->
qf_èbÀ
 !
NULL
;

32 
	}
}

35 
uöt64_t
 
	$gë_ñem
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
idx
)

37 
uöt64_t
 
ñt
 = 0;

38 
size_t
 
bôpos
 = 
qf
->
qf_ñem_bôs
 * 
idx
;

39 
size_t
 
èbpos
 = 
bôpos
 / 64;

40 
size_t
 
¶Ÿpos
 = 
bôpos
 % 64;

41 
•ûlbôs
 = (
¶Ÿpos
 + 
qf
->
qf_ñem_bôs
) - 64;

42 
ñt
 = (
qf
->
qf_èbÀ
[
èbpos
] >> 
¶Ÿpos
Ë& qf->
qf_ñem_mask
;

43 i‡(
•ûlbôs
 > 0) {

44 ++
èbpos
;

45 
uöt64_t
 
x
 = 
qf
->
qf_èbÀ
[
èbpos
] & 
	`LOW_MASK
(
•ûlbôs
);

46 
ñt
 |
x
 << (
qf
->
qf_ñem_bôs
 - 
•ûlbôs
);

48  
ñt
;

49 
	}
}

52 
	$£t_ñem
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
idx
, uöt64_à
ñt
)

54 
size_t
 
bôpos
 = 
qf
->
qf_ñem_bôs
 * 
idx
;

55 
size_t
 
èbpos
 = 
bôpos
 / 64;

56 
size_t
 
¶Ÿpos
 = 
bôpos
 % 64;

57 
•ûlbôs
 = (
¶Ÿpos
 + 
qf
->
qf_ñem_bôs
) - 64;

58 
ñt
 &
qf
->
qf_ñem_mask
;

59 
qf
->
qf_èbÀ
[
èbpos
] &~(qf->
qf_ñem_mask
 << 
¶Ÿpos
);

60 
qf
->
qf_èbÀ
[
èbpos
] |
ñt
 << 
¶Ÿpos
;

61 i‡(
•ûlbôs
 > 0) {

62 ++
èbpos
;

63 
qf
->
qf_èbÀ
[
èbpos
] &~
	`LOW_MASK
(
•ûlbôs
);

64 
qf
->
qf_èbÀ
[
èbpos
] |
ñt
 >> (qf->
qf_ñem_bôs
 - 
•ûlbôs
);

66 
	}
}

68 
ölöe
 
uöt64_t
 
	$ö¸
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
idx
)

70  (
idx
 + 1Ë& 
qf
->
qf_ödex_mask
;

71 
	}
}

73 
ölöe
 
uöt64_t
 
	$de¸
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
idx
)

75  (
idx
 - 1Ë& 
qf
->
qf_ödex_mask
;

76 
	}
}

78 
ölöe
 
	$is_occupõd
(
uöt64_t
 
ñt
)

80  
ñt
 & 1;

81 
	}
}

83 
ölöe
 
uöt64_t
 
	$£t_occupõd
(
uöt64_t
 
ñt
)

85  
ñt
 | 1;

86 
	}
}

88 
ölöe
 
uöt64_t
 
	$˛r_occupõd
(
uöt64_t
 
ñt
)

90  
ñt
 & ~1;

91 
	}
}

93 
ölöe
 
	$is_c⁄töu©i⁄
(
uöt64_t
 
ñt
)

95  
ñt
 & 2;

96 
	}
}

98 
ölöe
 
uöt64_t
 
	$£t_c⁄töu©i⁄
(
uöt64_t
 
ñt
)

100  
ñt
 | 2;

101 
	}
}

103 
ölöe
 
uöt64_t
 
	$˛r_c⁄töu©i⁄
(
uöt64_t
 
ñt
)

105  
ñt
 & ~2;

106 
	}
}

108 
ölöe
 
	$is_shi·ed
(
uöt64_t
 
ñt
)

110  
ñt
 & 4;

111 
	}
}

113 
ölöe
 
uöt64_t
 
	$£t_shi·ed
(
uöt64_t
 
ñt
)

115  
ñt
 | 4;

116 
	}
}

118 
ölöe
 
uöt64_t
 
	$˛r_shi·ed
(
uöt64_t
 
ñt
)

120  
ñt
 & ~4;

121 
	}
}

123 
ölöe
 
uöt64_t
 
	$gë_ªmaödî
(
uöt64_t
 
ñt
)

125  
ñt
 >> 3;

126 
	}
}

128 
ölöe
 
boﬁ
 
	$is_em±y_ñemít
(
uöt64_t
 
ñt
)

130  (
ñt
 & 7) == 0;

131 
	}
}

133 
ölöe
 
boﬁ
 
	$is_˛u°î_°¨t
(
uöt64_t
 
ñt
)

135  
	`is_occupõd
(
ñt
Ë&& !
	`is_c⁄töu©i⁄
”…Ë&& !
	`is_shi·ed
(elt);

136 
	}
}

138 
ölöe
 
boﬁ
 
	$is_run_°¨t
(
uöt64_t
 
ñt
)

140  !
	`is_c⁄töu©i⁄
(
ñt
Ë&& (
	`is_occupõd
”…Ë|| 
	`is_shi·ed
(elt));

141 
	}
}

143 
ölöe
 
uöt64_t
 
	$hash_to_quŸõ¡
(
quŸõ¡_fûãr
 *
qf
,

144 
uöt64_t
 
hash
)

146  (
hash
 >> 
qf
->
qf_rbôs
Ë& qf->
qf_ödex_mask
;

147 
	}
}

149 
ölöe
 
uöt64_t
 
	$hash_to_ªmaödî
(
quŸõ¡_fûãr
 *
qf
,

150 
uöt64_t
 
hash
)

152  
hash
 & 
qf
->
qf_rmask
;

153 
	}
}

156 
uöt64_t
 
	$föd_run_ödex
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
fq
)

159 
uöt64_t
 
b
 = 
fq
;

160 
	`is_shi·ed
(
	`gë_ñem
(
qf
, 
b
))) {

161 
b
 = 
	`de¸
(
qf
, b);

165 
uöt64_t
 
s
 = 
b
;

166 
b
 !
fq
) {

168 
s
 = 
	`ö¸
(
qf
, s);

169 } 
	`is_c⁄töu©i⁄
(
	`gë_ñem
(
qf
, 
s
)));

172 
b
 = 
	`ö¸
(
qf
, b);

173 } !
	`is_occupõd
(
	`gë_ñem
(
qf
, 
b
)));

175  
s
;

176 
	}
}

179 
	$ö£π_öto
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
s
, uöt64_à
ñt
)

181 
uöt64_t
 
¥ev
;

182 
uöt64_t
 
cuº
 = 
ñt
;

183 
boﬁ
 
em±y
;

186 
¥ev
 = 
	`gë_ñem
(
qf
, 
s
);

187 
em±y
 = 
	`is_em±y_ñemít
(
¥ev
);

188 i‡(!
em±y
) {

190 
¥ev
 = 
	`£t_shi·ed
(prev);

191 i‡(
	`is_occupõd
(
¥ev
)) {

192 
cuº
 = 
	`£t_occupõd
(curr);

193 
¥ev
 = 
	`˛r_occupõd
(prev);

196 
	`£t_ñem
(
qf
, 
s
, 
cuº
);

197 
cuº
 = 
¥ev
;

198 
s
 = 
	`ö¸
(
qf
, s);

199 } !
em±y
);

200 
	}
}

202 
boﬁ
 
	$qf_ö£π
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
hash
)

204 i‡(
qf
->
qf_íåõs
 >qf->
qf_max_size
) {

205  
Ál£
;

208 
uöt64_t
 
fq
 = 
	`hash_to_quŸõ¡
(
qf
, 
hash
);

209 
uöt64_t
 
‰
 = 
	`hash_to_ªmaödî
(
qf
, 
hash
);

210 
uöt64_t
 
T_fq
 = 
	`gë_ñem
(
qf
, 
fq
);

211 
uöt64_t
 
íåy
 = (
‰
 << 3) & ~7;

214 i‡(
	`is_em±y_ñemít
(
T_fq
)) {

215 
	`£t_ñem
(
qf
, 
fq
, 
	`£t_occupõd
(
íåy
));

216 ++
qf
->
qf_íåõs
;

217  
åue
;

220 i‡(!
	`is_occupõd
(
T_fq
)) {

221 
	`£t_ñem
(
qf
, 
fq
, 
	`£t_occupõd
(
T_fq
));

224 
uöt64_t
 
°¨t
 = 
	`föd_run_ödex
(
qf
, 
fq
);

225 
uöt64_t
 
s
 = 
°¨t
;

227 i‡(
	`is_occupõd
(
T_fq
)) {

230 
uöt64_t
 
ªm
 = 
	`gë_ªmaödî
(
	`gë_ñem
(
qf
, 
s
));

231 i‡(
ªm
 =
‰
) {

232  
åue
;

233 } i‡(
ªm
 > 
‰
) {

236 
s
 = 
	`ö¸
(
qf
, s);

237 } 
	`is_c⁄töu©i⁄
(
	`gë_ñem
(
qf
, 
s
)));

239 i‡(
s
 =
°¨t
) {

241 
uöt64_t
 
ﬁd_hód
 = 
	`gë_ñem
(
qf
, 
°¨t
);

242 
	`£t_ñem
(
qf
, 
°¨t
, 
	`£t_c⁄töu©i⁄
(
ﬁd_hód
));

245 
íåy
 = 
	`£t_c⁄töu©i⁄
(entry);

250 i‡(
s
 !
fq
) {

251 
íåy
 = 
	`£t_shi·ed
(entry);

254 
	`ö£π_öto
(
qf
, 
s
, 
íåy
);

255 ++
qf
->
qf_íåõs
;

256  
åue
;

257 
	}
}

259 
boﬁ
 
	$qf_may_c⁄èö
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
hash
)

261 
uöt64_t
 
fq
 = 
	`hash_to_quŸõ¡
(
qf
, 
hash
);

262 
uöt64_t
 
‰
 = 
	`hash_to_ªmaödî
(
qf
, 
hash
);

263 
uöt64_t
 
T_fq
 = 
	`gë_ñem
(
qf
, 
fq
);

266 i‡(!
	`is_occupõd
(
T_fq
)) {

267  
Ál£
;

271 
uöt64_t
 
s
 = 
	`föd_run_ödex
(
qf
, 
fq
);

273 
uöt64_t
 
ªm
 = 
	`gë_ªmaödî
(
	`gë_ñem
(
qf
, 
s
));

274 i‡(
ªm
 =
‰
) {

275  
åue
;

276 } i‡(
ªm
 > 
‰
) {

277  
Ál£
;

279 
s
 = 
	`ö¸
(
qf
, s);

280 } 
	`is_c⁄töu©i⁄
(
	`gë_ñem
(
qf
, 
s
)));

281  
Ál£
;

282 
	}
}

285 
	$dñëe_íåy
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
s
, uöt64_à
quŸ
)

287 
uöt64_t
 
√xt
;

288 
uöt64_t
 
cuº
 = 
	`gë_ñem
(
qf
, 
s
);

289 
uöt64_t
 
•
 = 
	`ö¸
(
qf
, 
s
);

290 
uöt64_t
 
‹ig
 = 
s
;

295 
åue
) {

296 
√xt
 = 
	`gë_ñem
(
qf
, 
•
);

297 
boﬁ
 
cuº_occupõd
 = 
	`is_occupõd
(
cuº
);

299 i‡(
	`is_em±y_ñemít
(
√xt
Ë|| 
	`is_˛u°î_°¨t
“extË|| 
•
 =
‹ig
) {

300 
	`£t_ñem
(
qf
, 
s
, 0);

304 
uöt64_t
 
upd©ed_√xt
 = 
√xt
;

305 i‡(
	`is_run_°¨t
(
√xt
)) {

307 
quŸ
 = 
	`ö¸
(
qf
, quot);

308 } !
	`is_occupõd
(
	`gë_ñem
(
qf
, 
quŸ
)));

310 i‡(
cuº_occupõd
 && 
quŸ
 =
s
) {

311 
upd©ed_√xt
 = 
	`˛r_shi·ed
(
√xt
);

315 
	`£t_ñem
(
qf
, 
s
, 
cuº_occupõd
 ?

316 
	`£t_occupõd
(
upd©ed_√xt
) :

317 
	`˛r_occupõd
(
upd©ed_√xt
));

318 
s
 = 
•
;

319 
•
 = 
	`ö¸
(
qf
, sp);

320 
cuº
 = 
√xt
;

323 
	}
}

325 
boﬁ
 
	$qf_ªmove
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
hash
)

327 
uöt64_t
 
highbôs
 = 
hash
 >> (
qf
->
qf_qbôs
 + qf->
qf_rbôs
);

328 i‡(
highbôs
) {

329  
Ál£
;

332 
uöt64_t
 
fq
 = 
	`hash_to_quŸõ¡
(
qf
, 
hash
);

333 
uöt64_t
 
‰
 = 
	`hash_to_ªmaödî
(
qf
, 
hash
);

334 
uöt64_t
 
T_fq
 = 
	`gë_ñem
(
qf
, 
fq
);

336 i‡(!
	`is_occupõd
(
T_fq
Ë|| !
qf
->
qf_íåõs
) {

337  
åue
;

340 
uöt64_t
 
°¨t
 = 
	`föd_run_ödex
(
qf
, 
fq
);

341 
uöt64_t
 
s
 = 
°¨t
;

342 
uöt64_t
 
ªm
;

346 
ªm
 = 
	`gë_ªmaödî
(
	`gë_ñem
(
qf
, 
s
));

347 i‡(
ªm
 =
‰
) {

349 } i‡(
ªm
 > 
‰
) {

350  
åue
;

352 
s
 = 
	`ö¸
(
qf
, s);

353 } 
	`is_c⁄töu©i⁄
(
	`gë_ñem
(
qf
, 
s
)));

354 i‡(
ªm
 !
‰
) {

355  
åue
;

358 
uöt64_t
 
kûl
 = (
s
 =
fq
Ë? 
T_fq
 : 
	`gë_ñem
(
qf
, s);

359 
boﬁ
 
ª∂a˚_run_°¨t
 = 
	`is_run_°¨t
(
kûl
);

362 i‡(
	`is_run_°¨t
(
kûl
)) {

363 
uöt64_t
 
√xt
 = 
	`gë_ñem
(
qf
, 
	`ö¸
(qf, 
s
));

364 i‡(!
	`is_c⁄töu©i⁄
(
√xt
)) {

365 
T_fq
 = 
	`˛r_occupõd
(T_fq);

366 
	`£t_ñem
(
qf
, 
fq
, 
T_fq
);

370 
	`dñëe_íåy
(
qf
, 
s
, 
fq
);

372 i‡(
ª∂a˚_run_°¨t
) {

373 
uöt64_t
 
√xt
 = 
	`gë_ñem
(
qf
, 
s
);

374 
uöt64_t
 
upd©ed_√xt
 = 
√xt
;

375 i‡(
	`is_c⁄töu©i⁄
(
√xt
)) {

377 
upd©ed_√xt
 = 
	`˛r_c⁄töu©i⁄
(
√xt
);

379 i‡(
s
 =
fq
 && 
	`is_run_°¨t
(
upd©ed_√xt
)) {

381 
upd©ed_√xt
 = 
	`˛r_shi·ed
(updated_next);

383 i‡(
upd©ed_√xt
 !
√xt
) {

384 
	`£t_ñem
(
qf
, 
s
, 
upd©ed_√xt
);

388 --
qf
->
qf_íåõs
;

389  
åue
;

390 
	}
}

392 
boﬁ
 
	$qf_mîge
(
quŸõ¡_fûãr
 *
qf1
, quŸõ¡_fûã∏*
qf2
,

393 
quŸõ¡_fûãr
 *
qfout
)

395 
uöt32_t
 
q
 = 1 + 
	`MAX
(
qf1
->
qf_qbôs
, 
qf2
->qf_qbits);

396 
uöt32_t
 
r
 = 
	`MAX
(
qf1
->
qf_rbôs
, 
qf2
->qf_rbits);

397 i‡(!
	`qf_öô
(
qfout
, 
q
, 
r
)) {

398  
Ál£
;

401 
qf_ôî©‹
 
qfi
;

402 
	`qfi_°¨t
(
qf1
, &
qfi
);

403 !
	`qfi_d⁄e
(
qf1
, &
qfi
)) {

404 
	`qf_ö£π
(
qfout
, 
	`qfi_√xt
(
qf1
, &
qfi
));

406 
	`qfi_°¨t
(
qf2
, &
qfi
);

407 !
	`qfi_d⁄e
(
qf2
, &
qfi
)) {

408 
	`qf_ö£π
(
qfout
, 
	`qfi_√xt
(
qf2
, &
qfi
));

410  
åue
;

411 
	}
}

413 
	$qf_˛ór
(
quŸõ¡_fûãr
 *
qf
)

415 
qf
->
qf_íåõs
 = 0;

416 
	`mem£t
(
qf
->
qf_èbÀ
, 0, 
	`qf_èbÀ_size
(qf->
qf_qbôs
, qf->
qf_rbôs
));

417 
	}
}

419 
size_t
 
	$qf_èbÀ_size
(
uöt32_t
 
q
, uöt32_à
r
)

421 
size_t
 
bôs
 = (1 << 
q
Ë* (
r
 + 3);

422 
size_t
 
byãs
 = 
bôs
 / 8;

423  (
bôs
 % 8Ë? (
byãs
 + 1) : bytes;

424 
	}
}

426 
	$qf_de°roy
(
quŸõ¡_fûãr
 *
qf
)

428 
	`‰ì
(
qf
->
qf_èbÀ
);

429 
	}
}

431 
	$qfi_°¨t
(
quŸõ¡_fûãr
 *
qf
, 
qf_ôî©‹
 *
i
)

434 
i
->
qfi_visôed
 = 
qf
->
qf_íåõs
;

436 i‡(
qf
->
qf_íåõs
 == 0) {

441 
uöt64_t
 
°¨t
;

442 
°¨t
 = 0; sèπ < 
qf
->
qf_max_size
; ++start) {

443 i‡(
	`is_˛u°î_°¨t
(
	`gë_ñem
(
qf
, 
°¨t
))) {

448 
i
->
qfi_visôed
 = 0;

449 
i
->
qfi_ödex
 = 
°¨t
;

450 
	}
}

452 
boﬁ
 
	$qfi_d⁄e
(
quŸõ¡_fûãr
 *
qf
, 
qf_ôî©‹
 *
i
)

454  
qf
->
qf_íåõs
 =
i
->
qfi_visôed
;

455 
	}
}

457 
uöt64_t
 
	$qfi_√xt
(
quŸõ¡_fûãr
 *
qf
, 
qf_ôî©‹
 *
i
)

459 !
	`qfi_d⁄e
(
qf
, 
i
)) {

460 
uöt64_t
 
ñt
 = 
	`gë_ñem
(
qf
, 
i
->
qfi_ödex
);

463 i‡(
	`is_˛u°î_°¨t
(
ñt
)) {

464 
i
->
qfi_quŸõ¡
 = i->
qfi_ödex
;

466 i‡(
	`is_run_°¨t
(
ñt
)) {

467 
uöt64_t
 
quŸ
 = 
i
->
qfi_quŸõ¡
;

469 
quŸ
 = 
	`ö¸
(
qf
, quot);

470 } !
	`is_occupõd
(
	`gë_ñem
(
qf
, 
quŸ
)));

471 
i
->
qfi_quŸõ¡
 = 
quŸ
;

475 
i
->
qfi_ödex
 = 
	`ö¸
(
qf
, i->qfi_index);

477 i‡(!
	`is_em±y_ñemít
(
ñt
)) {

478 
uöt64_t
 
quŸ
 = 
i
->
qfi_quŸõ¡
;

479 
uöt64_t
 
ªm
 = 
	`gë_ªmaödî
(
ñt
);

480 
uöt64_t
 
hash
 = (
quŸ
 << 
qf
->
qf_rbôs
Ë| 
ªm
;

481 ++
i
->
qfi_visôed
;

482  
hash
;

486 
	`ab‹t
();

487 
	}
}

	@qf.h

7 #¥agm®
⁄˚


9 
	~<°döt.h
>

10 
	~<°dboﬁ.h
>

12 
	squŸõ¡_fûãr
 {

13 
uöt8_t
 
	mqf_qbôs
;

14 
uöt8_t
 
	mqf_rbôs
;

15 
uöt8_t
 
	mqf_ñem_bôs
;

16 
uöt32_t
 
	mqf_íåõs
;

17 
uöt64_t
 
	mqf_ödex_mask
;

18 
uöt64_t
 
	mqf_rmask
;

19 
uöt64_t
 
	mqf_ñem_mask
;

20 
uöt64_t
 
	mqf_max_size
;

21 
uöt64_t
 *
	mqf_èbÀ
;

24 
	sqf_ôî©‹
 {

25 
uöt64_t
 
	mqfi_ödex
;

26 
uöt64_t
 
	mqfi_quŸõ¡
;

27 
uöt64_t
 
	mqfi_visôed
;

36 
boﬁ
 
qf_öô
(
quŸõ¡_fûãr
 *
qf
, 
uöt32_t
 
q
, uöt32_à
r
);

44 
boﬁ
 
qf_ö£π
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
hash
);

49 
boﬁ
 
qf_may_c⁄èö
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
hash
);

65 
boﬁ
 
qf_ªmove
(
quŸõ¡_fûãr
 *
qf
, 
uöt64_t
 
hash
);

73 
boﬁ
 
qf_mîge
(
quŸõ¡_fûãr
 *
qf1
, quŸõ¡_fûã∏*
qf2
,

74 
quŸõ¡_fûãr
 *
qfout
);

79 
qf_˛ór
(
quŸõ¡_fûãr
 *
qf
);

86 
size_t
 
qf_èbÀ_size
(
uöt32_t
 
q
, uöt32_à
r
);

91 
qf_de°roy
(
quŸõ¡_fûãr
 *
qf
);

96 
qfi_°¨t
(
quŸõ¡_fûãr
 *
qf
, 
qf_ôî©‹
 *
i
);

101 
boﬁ
 
qfi_d⁄e
(
quŸõ¡_fûãr
 *
qf
, 
qf_ôî©‹
 *
i
);

108 
uöt64_t
 
qfi_√xt
(
quŸõ¡_fûãr
 *
qf
, 
qf_ôî©‹
 *
i
);

	@test.cc

8 
	~"qf.c
"

11 
	#QBENCH
 1

	)

13 
	~<£t
>

14 
	~<ve˘‹
>

15 
	~<ˇs£π
>

16 
	~<c°dio
>

17 
	~<cm©h
>

18 
	~<sys/time.h
>

20 
usög
 
«me•a˚
 
°d
;

23 c⁄° 
uöt32_t
 
	gQ_MAX
 = 12;

24 c⁄° 
uöt32_t
 
	gR_MAX
 = 6;

25 c⁄° 
uöt32_t
 
	gROUNDS_MAX
 = 1000;

27 
	$Áû
(
quŸõ¡_fûãr
 *
qf
, c⁄° *
s
)

29 
	`Ârötf
(
°dîr
, "qf(q=%u,Ñ=%u): %s\n", 
qf
->
qf_qbôs
, qf->
qf_rbôs
, 
s
);

30 
	`ab‹t
();

31 
	}
}

33 
uöt64_t
 
	$ønd64
()

35  (((
uöt64_t
Ë
	`ønd
()) << 32) | ((uint64_t)Ñand());

36 
	}
}

38 
	$qf_¥öt
(
quŸõ¡_fûãr
 *
qf
)

40 
buf
[32];

41 
uöt32_t
 
∑d
 = 
	`uöt32_t
(
	`˚û
((
qf
->
qf_qbôs
Ë/ 
	`logf
(10.f))) + 1;

43 
uöt32_t
 
i
 = 0; i < 
∑d
; ++i) {

44 
	`¥ötf
(" ");

46 
	`¥ötf
("| is_shifted | is_continuation | is_occupied |Ñemainder"

47 "Çñ=%u\n", 
qf
->
qf_íåõs
);

49 
uöt64_t
 
idx
 = 0; idx < 
qf
->
qf_max_size
; ++idx) {

50 
	`¢¥ötf
(
buf
, (buf), "%Œu", 
idx
);

51 
	`¥ötf
("%s", 
buf
);

53 
fûl•a˚
 = 
∑d
 - 
	`°æí
(
buf
);

54 
i
 = 0; i < 
fûl•a˚
; ++i) {

55 
	`¥ötf
(" ");

57 
	`¥ötf
("| ");

59 
uöt64_t
 
ñt
 = 
	`gë_ñem
(
qf
, 
idx
);

60 
	`¥ötf
("%d | ", !!
	`is_shi·ed
(
ñt
));

61 
	`¥ötf
("%d | ", !!
	`is_c⁄töu©i⁄
(
ñt
));

62 
	`¥ötf
("%d | ", !!
	`is_occupõd
(
ñt
));

63 
	`¥ötf
("%Œu\n", 
	`gë_ªmaödî
(
ñt
));

65 
	}
}

68 
	$qf_c⁄si°ít
(
quŸõ¡_fûãr
 *
qf
)

70 
	`as£π
(
qf
->
qf_qbôs
);

71 
	`as£π
(
qf
->
qf_rbôs
);

72 
	`as£π
(
qf
->
qf_qbôs
 + qf->
qf_rbôs
 <= 64);

73 
	`as£π
(
qf
->
qf_ñem_bôs
 =(qf->
qf_rbôs
 + 3));

74 
	`as£π
(
qf
->
qf_èbÀ
);

76 
uöt64_t
 
idx
;

77 
uöt64_t
 
°¨t
;

78 
uöt64_t
 
size
 = 
qf
->
qf_max_size
;

79 
	`as£π
(
qf
->
qf_íåõs
 <
size
);

80 
uöt64_t
 
œ°_run_ñt
;

81 
uöt64_t
 
visôed
 = 0;

83 i‡(
qf
->
qf_íåõs
 == 0) {

84 
°¨t
 = 0; sèπ < 
size
; ++start) {

85 
	`as£π
(
	`gë_ñem
(
qf
, 
°¨t
) == 0);

90 
°¨t
 = 0; sèπ < 
size
; ++start) {

91 i‡(
	`is_˛u°î_°¨t
(
	`gë_ñem
(
qf
, 
°¨t
))) {

96 
	`as£π
(
°¨t
 < 
size
);

98 
idx
 = 
°¨t
;

100 
uöt64_t
 
ñt
 = 
	`gë_ñem
(
qf
, 
idx
);

103 i‡(
	`is_em±y_ñemít
(
ñt
)) {

104 
	`as£π
(
	`gë_ªmaödî
(
ñt
) == 0);

108 i‡(
	`is_c⁄töu©i⁄
(
ñt
)) {

109 
	`as£π
(
	`is_shi·ed
(
ñt
));

112 
uöt64_t
 
¥ev
 = 
	`gë_ñem
(
qf
, 
	`de¸
(qf, 
idx
));

113 
	`as£π
(!
	`is_em±y_ñemít
(
¥ev
));

117 i‡(!
	`is_em±y_ñemít
(
ñt
)) {

118 
uöt64_t
 
ªm
 = 
	`gë_ªmaödî
(
ñt
);

119 i‡(
	`is_c⁄töu©i⁄
(
ñt
)) {

120 
	`as£π
(
ªm
 > 
œ°_run_ñt
);

122 
œ°_run_ñt
 = 
ªm
;

123 ++
visôed
;

126 
idx
 = 
	`ö¸
(
qf
, idx);

127 } 
idx
 !
°¨t
);

129 
	`as£π
(
qf
->
qf_íåõs
 =
visôed
);

130 
	}
}

133 
uöt64_t
 
gíhash
(
quŸõ¡_fûãr
 *
qf
, 
boﬁ
 
˛rhigh
,

134 
£t
<
uöt64_t
> &
keys
)

136 
uöt64_t
 
	ghash
;

137 
uöt64_t
 
	gmask
 = 
˛rhigh
 ? 
LOW_MASK
(
qf
->
qf_qbôs
 + qf->
qf_rbôs
) : ~0ULL;

138 
uöt64_t
 
	gsize
 = 
qf
->
qf_max_size
;

141 i‡(
	gkeys
.
size
(Ë> (3 * (
	gsize
 / 4))) {

142 
uöt64_t
 
	g¥obe
;

143 
uöt64_t
 
	g°¨t
 = 
ønd64
(Ë& 
qf
->
qf_ödex_mask
;

144 
	g¥obe
 = 
ö¸
(
qf
, 
°¨t
);Örobê!°¨t;Örobêö¸(qf, 
¥obe
)) {

145 i‡(
is_em±y_ñemít
(
gë_ñem
(
qf
, 
¥obe
))) {

146 
uöt64_t
 
	ghi
 = 
˛rhigh
 ? 0 : (
ønd64
(Ë& ~
mask
);

147 
	ghash
 = 
hi
 | (
¥obe
 << 
qf
->
qf_rbôs
Ë| (
ønd64
(Ë& qf->
qf_rmask
);

148 i‡(!
	gkeys
.
cou¡
(
hash
)) {

149  
	ghash
;

157 
	ghash
 = 
ønd64
(Ë& 
mask
;

158 } 
	gkeys
.
cou¡
(
hash
));

159  
	ghash
;

163 
ht_put
(
quŸõ¡_fûãr
 *
qf
, 
£t
<
uöt64_t
> &
keys
)

165 
uöt64_t
 
	ghash
 = 
gíhash
(
qf
, 
åue
, 
keys
);

166 
as£π
(
qf_ö£π
(
qf
, 
hash
));

167 
	gkeys
.
ö£π
(
hash
);

171 
ht_dñ
(
quŸõ¡_fûãr
 *
qf
, 
£t
<
uöt64_t
> &
keys
)

173 
	g£t
<
	guöt64_t
>::
ôî©‹
 
ô
;

174 
uöt64_t
 
	gidx
 = 
ønd64
(Ë% 
keys
.
size
();

175 
	gô
 = 
keys
.
begö
(); ià!keys.
íd
(Ë&& 
idx
; ++ô, --
	gidx
);

176 
uöt64_t
 
	ghash
 = *
ô
;

177 
as£π
(
qf_ªmove
(
qf
, 
hash
));

178 
as£π
(!
qf_may_c⁄èö
(
qf
, 
hash
));

179 
	gkeys
.
îa£
(
hash
);

183 
ht_check
(
quŸõ¡_fûãr
 *
qf
, 
£t
<
uöt64_t
> &
keys
)

185 
qf_c⁄si°ít
(
qf
);

186 
	g£t
<
	guöt64_t
>::
ôî©‹
 
ô
;

187 
	gô
 = 
keys
.
begö
(); ià!keys.
íd
(); ++it) {

188 
uöt64_t
 
	ghash
 = *
ô
;

189 
as£π
(
qf_may_c⁄èö
(
qf
, 
hash
));

193 
	$qf_ã°
(
quŸõ¡_fûãr
 *
qf
)

196 
uöt64_t
 
idx
;

197 
uöt64_t
 
size
 = 
qf
->
qf_max_size
;

198 
idx
 = 0; idx < 
size
; ++idx) {

199 
	`as£π
(
	`gë_ñem
(
qf
, 
idx
) == 0);

200 
	`£t_ñem
(
qf
, 
idx
, idx & qf->
qf_ñem_mask
);

202 
idx
 = 0; idx < 
size
; ++idx) {

203 
	`as£π
(
	`gë_ñem
(
qf
, 
idx
Ë=(idx & qf->
qf_ñem_mask
));

205 
	`qf_˛ór
(
qf
);

208 
ve˘‹
<
uöt64_t
> 
	`ñemíts
(
size
, 0);

209 
idx
 = 0; idx < 
size
; ++idx) {

210 
uöt64_t
 
¶Ÿ
 = 
	`ønd64
(Ë% 
size
;

211 
uöt64_t
 
hash
 = 
	`ønd64
();

212 
	`£t_ñem
(
qf
, 
¶Ÿ
, 
hash
 & qf->
qf_ñem_mask
);

213 
ñemíts
[
¶Ÿ
] = 
hash
 & 
qf
->
qf_ñem_mask
;

215 
idx
 = 0; idx < 
ñemíts
.
	`size
(); ++idx) {

216 
	`as£π
(
	`gë_ñem
(
qf
, 
idx
Ë=
ñemíts
[idx]);

218 
	`qf_˛ór
(
qf
);

221 
£t
<
uöt64_t
> 
keys
;

222 
idx
 = 0; idx < 
size
; ++idx) {

223 
uöt64_t
 
ñt
 = 
	`gíhash
(
qf
, 
Ál£
, 
keys
);

224 
	`as£π
(
	`qf_ö£π
(
qf
, 
ñt
));

225 
keys
.
	`ö£π
(
ñt
);

227 
	`ht_check
(
qf
, 
keys
);

228 
keys
.
	`˛ór
();

229 
	`qf_˛ór
(
qf
);

232 
idx
 = 0; idx < 
ROUNDS_MAX
; ++idx) {

233 
qf
->
qf_íåõs
 < 
size
) {

234 
	`ht_put
(
qf
, 
keys
);

237 
qf
->
qf_íåõs
 > (
size
 / 2)) {

238 
	`ht_dñ
(
qf
, 
keys
);

240 
	`ht_check
(
qf
, 
keys
);

242 
qf_ôî©‹
 
qfi
;

243 
	`qfi_°¨t
(
qf
, &
qfi
);

244 !
	`qfi_d⁄e
(
qf
, &
qfi
)) {

245 
uöt64_t
 
hash
 = 
	`qfi_√xt
(
qf
, &
qfi
);

246 
	`as£π
(
keys
.
	`cou¡
(
hash
));

249 
	}
}

252 
	$øndom_fûl
(
quŸõ¡_fûãr
 *
qf
)

254 
£t
<
uöt64_t
> 
keys
;

255 
uöt64_t
 
ñts
 = ((uöt64_tË
	`ønd
()Ë% 
qf
->
qf_max_size
;

256 
ñts
) {

257 
	`ht_put
(
qf
, 
keys
);

258 --
ñts
;

260 
	`qf_c⁄si°ít
(
qf
);

261 
	}
}

264 
	$sub£tof
(
quŸõ¡_fûãr
 *
lhs
, quŸõ¡_fûã∏*
rhs
)

266 
qf_ôî©‹
 
qfi
;

267 
	`qfi_°¨t
(
lhs
, &
qfi
);

268 !
	`qfi_d⁄e
(
lhs
, &
qfi
)) {

269 
uöt64_t
 
hash
 = 
	`qfi_√xt
(
lhs
, &
qfi
);

270 
	`as£π
(
	`qf_may_c⁄èö
(
rhs
, 
hash
));

272 
	}
}

275 
	$su≥r£tof
(
quŸõ¡_fûãr
 *
qf
, quŸõ¡_fûã∏*
qf1
,

276 
quŸõ¡_fûãr
 *
qf2
)

278 
qf_ôî©‹
 
qfi
;

279 
	`qfi_°¨t
(
qf
, &
qfi
);

280 !
	`qfi_d⁄e
(
qf
, &
qfi
)) {

281 
uöt64_t
 
hash
 = 
	`qfi_√xt
(
qf
, &
qfi
);

282 
	`as£π
(
	`qf_may_c⁄èö
(
qf1
, 
hash
Ë|| qf_may_c⁄èö(
qf2
, hash));

284 
	}
}

286 
	$qf_bích
()

288 
quŸõ¡_fûãr
 
qf
;

289 c⁄° 
uöt32_t
 
q_œrge
 = 28;

290 c⁄° 
uöt32_t
 
q_smÆl
 = 16;

291 c⁄° 
uöt32_t
 
∆ookups
 = 1000000;

292 
timevÆ
 
tv1
, 
tv2
;

293 
uöt64_t
 
£c
;

296 
uöt32_t
 
nö£πs
 = (3 * (1 << 
q_œrge
) / 4);

297 
	`¥ötf
("Te°ög %uÑ™dom in£π†™d %uÜookups", 
nö£πs
, 
∆ookups
);

298 
	`fÊush
(
°dout
);

299 
	`qf_öô
(&
qf
, 
q_œrge
, 1);

300 
	`gëtimeofday
(&
tv1
, 
NULL
);

301 
qf
.
qf_íåõs
 < 
nö£πs
) {

302 
	`as£π
(
	`qf_ö£π
(&
qf
, (
uöt64_t
Ë
	`ønd
()));

303 i‡(
qf
.
qf_íåõs
 % 10000000 == 0) {

304 
	`¥ötf
(".");

305 
	`fÊush
(
°dout
);

308 
uöt32_t
 
i
 = 0; i < 
∆ookups
; ++i) {

309 
	`qf_may_c⁄èö
(&
qf
, (
uöt64_t
Ë
	`ønd
());

311 
	`gëtimeofday
(&
tv2
, 
NULL
);

312 
£c
 = 
tv2
.
tv_£c
 - 
tv1
.tv_sec;

313 
	`¥ötf
(" d⁄ê(%Œu sec⁄ds).\n", 
£c
);

314 
	`fÊush
(
°dout
);

315 
	`qf_de°roy
(&
qf
);

318 
	`qf_öô
(&
qf
, 
q_smÆl
, 1);

319 
	`¥ötf
("Te°ög %u c⁄tiguou†ö£π†™d %uÜookups", 1 << 
q_smÆl
,

320 
∆ookups
);

321 
	`fÊush
(
°dout
);

322 
	`gëtimeofday
(&
tv1
, 
NULL
);

323 
uöt64_t
 
quŸ
 = 0; quŸ < (1 << (
q_smÆl
 - 1)); ++quot) {

324 
uöt64_t
 
hash
 = 
quŸ
 << 1;

325 
	`as£π
(
	`qf_ö£π
(&
qf
, 
hash
));

326 
	`as£π
(
	`qf_ö£π
(&
qf
, 
hash
 | 1));

327 i‡(
quŸ
 % 2000 == 0) {

328 
	`¥ötf
(".");

329 
	`fÊush
(
°dout
);

332 
uöt32_t
 
i
 = 0; i < 
∆ookups
; ++i) {

333 
	`qf_may_c⁄èö
(&
qf
, (
uöt64_t
Ë
	`ønd
());

334 i‡(
i
 % 50000 == 0) {

335 
	`¥ötf
(".");

336 
	`fÊush
(
°dout
);

339 
	`gëtimeofday
(&
tv2
, 
NULL
);

340 
£c
 = 
tv2
.
tv_£c
 - 
tv1
.tv_sec;

341 
	`¥ötf
(" d⁄ê(%Œu sec⁄ds).\n", 
£c
);

342 
	`fÊush
(
°dout
);

343 
	`qf_de°roy
(&
qf
);

344 
	}
}

346 
	$maö
()

348 
	`§™d
(0);

350 
quŸõ¡_fûãr
 
qf_dummy
;

351 
	`qf_öô
(&
qf_dummy
, 17, 8);

352 
	`qf_de°roy
(&
qf_dummy
);

354 #i‡
QBENCH


355 
	`qf_bích
();

357 
uöt32_t
 
q
 = 1; q <
Q_MAX
; ++q) {

358 
	`¥ötf
("SèπögÑound†f‹ qf_ã°::q=%u\n", 
q
);

360 #¥agm®
omp
 
∑øŒñ
 

361 
uöt32_t
 
r
 = 1;Ñ <
R_MAX
; ++r) {

362 
quŸõ¡_fûãr
 
qf
;

363 i‡(!
	`qf_öô
(&
qf
, 
q
, 
r
)) {

364 
	`Áû
(&
qf
, "init-1");

366 
	`qf_ã°
(&
qf
);

367 
	`qf_de°roy
(&
qf
);

371 
uöt32_t
 
q1
 = 1; q1 <
Q_MAX
; ++q1) {

372 
uöt32_t
 
r1
 = 1;Ñ1 <
R_MAX
; ++r1) {

373 
uöt32_t
 
q2
 = 1; q2 <
Q_MAX
; ++q2) {

374 
	`¥ötf
("SèπögÑound†f‹ qf_mîge::q1=%u,q2=%u\n", 
q1
, 
q2
);

376 #¥agm®
omp
 
∑øŒñ
 

377 
uöt32_t
 
r2
 = 1;Ñ2 <
R_MAX
; ++r2) {

378 
quŸõ¡_fûãr
 
qf
;

379 
quŸõ¡_fûãr
 
qf1
, 
qf2
;

380 i‡(!
	`qf_öô
(&
qf1
, 
q1
, 
r1
Ë|| !qf_öô(&
qf2
, 
q2
, 
r2
)) {

381 
	`Áû
(&
qf1
, "init-2");

384 
	`øndom_fûl
(&
qf1
);

385 
	`øndom_fûl
(&
qf2
);

386 
	`as£π
(
	`qf_mîge
(&
qf1
, &
qf2
, &
qf
));

387 
	`qf_c⁄si°ít
(&
qf
);

388 
	`sub£tof
(&
qf1
, &
qf
);

389 
	`sub£tof
(&
qf2
, &
qf
);

390 
	`su≥r£tof
(&
qf
, &
qf1
, &
qf2
);

391 
	`qf_de°roy
(&
qf1
);

392 
	`qf_de°roy
(&
qf2
);

393 
	`qf_de°roy
(&
qf
);

400 
	`puts
("[PASSED] qfÅests");

402 
	}
}

	@
1
.
0
3
18
qf.c
qf.h
test.cc
